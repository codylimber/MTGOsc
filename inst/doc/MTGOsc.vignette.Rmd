---
title: "MTGOsc: MTGO analysis on single cells"
author: "Nelson Nazzicari, Simone Marini, Danila Vella"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{MTGOsc: MTGO analysis on single cells}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
<!-- 
PLEASE NOTE

This is a vignette and it's not rebuilt automatically with the package.
To do so please use the following command:

devtools::build_vignettes()

And *then* rebuild the package, so it updates the doc.
--> 

## Example data

MTGOsc comes with some example data from the Mouse Atlas in the form of a (simplified for storage reasons) Seurat object. Let's start with loading Seurat and MTGO:

```{r, echo=TRUE, eval=TRUE, results=FALSE, message=FALSE}
library(Seurat)
library(MTGOsc)
```

Loading MTGOsc also loads three objects: *bladder*, *markers*, and *mouse.pathways*.

```{r, echo=TRUE, eval=TRUE}
#this is a (simplified) Seurat object
print(bladder)

#this come from applying Seurat function FindAllMarkers() to the bladder dataset
head(markers)

#this is a simple gene -> pathway dictionary
head(mouse.pathways)
```

Bladder object contains three clusters:

```{r, echo=TRUE, eval=TRUE}
table(bladder@ident)
```

For this tutorial we'll focus on Basal epitelial cells cluster, which is of intermediate size. We create two "selector" arrays, one for cells and one for genes.

```{r, echo=TRUE, eval=TRUE}
cells.selected = bladder@ident == 'Basal epithelial cell(Bladder)'
genes.selected = subset(markers, cluster == 'Basal epithelial cell(Bladder)')$gene

my.bladder = bladder
my.bladder@data = my.bladder@data[genes.selected, cells.selected]
```

MTGOsc needs a folder where to save temporary files and final results.

```{r, echo=TRUE, eval=TRUE}
root = tempdir() #change this to your preferred local path
dir.create(root, recursive = TRUE, showWarnings = FALSE)
```

We are now ready to start with MTGOsc:

```{r, echo=TRUE, eval=TRUE}
dict = write.dictionary(genes=mouse.pathways$gene, terms = mouse.pathways$pathway, outfolder = root)
coexp = write.coexpressionMatrix(geneExpression = my.bladder, outfolder = root)
edges = write.edges(coexpression = coexp, outfolder = root, keep.weights = FALSE, fun = scale_free_threshold)
write.paramFile(outfolder = root)
call.MTGO(outfolder = root, verbose = TRUE)
network.collapsed = export.network.modules(infolder = root, collapse.modules = TRUE) 
network.full = export.network.modules(infolder = root, collapse.modules = FALSE) 
```

## Gene module enrichment on Reactome
```{r eval=FALSE, include=FALSE}
# Here we look for Reactome pathway enrichment of the genes constituting the thinned network. This procedure is
# complementary to the exctraction of Reactome pathways by MTGO-SC.

# load libraries for gene enrichment on Reactome
library(ReactomePA)
library(clusterProfiler)

firstup <- function(x) {
  x <- tolower(x)
  substr(x, 1, 1) <- toupper(substr(x, 1, 1))
  return(x)
}

# collecting all the genes 
files <- list.files(path = "../ReactomeErichment")

genes = unique(c(edges$gene1, edges$gene2)

for (file in files){
  genes <- read.table(file, stringsAsFactors = FALSE) #cambiare
  genes <- firstup(genes[2:length(genes$V1),]) #prima lettera maiuscola, tenere
  genes = bitr(genes, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Mm.eg.db") #va scaricato "org.Mm.eg.db"
  genes = genes$ENTREZID
  names <- strsplit(file, "/")
  name <- names[[1]][length(names[[1]])]
  enriched <- enrichPathway(gene=genes, pvalueCutoff=0.05, readable=T, organism = "mouse", pAdjustMethod = "BH")
  write.table(enriched, file = paste("../ReactomeErichment/ReactomePA.", name, sep = ""), row.names = FALSE, quote = FALSE, sep = ",")
}
```

## Enriched term literature search with RISmed

```{r eval=FALSE, include=FALSE}
# In this example we search the literature for the Basal Epithelial cell type and the pathway terms
# retrieved by both MTGO-SC (pathway labelling gene modules) and ReactomePA (pathways enriched for the whole basal epithelial gene network

library(RISmed)

# set the search parameters
file_MTGO<-"Modules_Best_QGO.txt" #path
file_enriched<-"Basal epithelial cell" #passare la variabile
tissue<-"Bladder"
celltype<-"Basal Epithelial Cell"

modules<-read.table(file_MTGO,sep="\t",header=T)
terms_MTGO<-as.character(modules[,4])
terms_enriched<-setdiff(as.character(read.table(file_enriched,header=T)[,1]),NA)

terms<-union(terms_MTGO,terms_enriched)


# Perform all the PUBMED searchings

pubmed_search_both<-c()
pubmed_search_term<-c()
for(k in terms)
{
  print(k)
  res <- EUtilsSummary(paste(tissue,celltype,k), type="esearch", db="pubmed", datetype='pdat', mindate=2000, maxdate=2019, retmax=500)
  pubmed_search_both[[k]]<-QueryCount(res)
  res <- EUtilsSummary(paste(tissue,k), type="esearch", db="pubmed", datetype='pdat', mindate=2000, maxdate=2019, retmax=500)
  pubmed_search_term[[k]]<-QueryCount(res)
  Sys.sleep(0.5)  # a connection error might occur without this pause
}

pubmed_search_universe<-QueryCount(EUtilsSummary(tissue, type="esearch", db="pubmed", datetype='pdat', mindate=2000, maxdate=2019, retmax=500))
pubmed_search_celltype<-QueryCount(EUtilsSummary(paste(tissue,celltype), type="esearch", db="pubmed", datetype='pdat', mindate=2000, maxdate=2019, retmax=500))


# Compute p.values

pvals<-c()

M<-pubmed_search_celltype
N<-pubmed_search_universe

for(i in terms)
{
    x<-pubmed_search_both[[i]]
    k<-pubmed_search_term[[i]]
    pvals[[i]]<-signif(phyper(x-1,M,N-M,k,lower.tail=F),2)
}

PUBMEDsearch_results<-cbind(terms,pvals,pubmed_search_both,pubmed_search_term,pubmed_search_celltype,pubmed_search_universe)
```












